# 微信小程序视频开发相关的总结与思考

## 前言
1. 公司需要开发一个类似于视频片段过程中会弹出一些交互，进行操作之后根据用户的选择切换下个视频
2. 需要在小程序上开发这个功能

## 设计数据结构
1. 由于是第一版进行实验性，所以没有加入后台配置，主要都有前端开发进行实现
2. 需要设计一个视频片段的播放序列结构，原本想通过数组对象，每个数组对象都有一个next属性，指向下个要播放的视频数组的index，后边发现这样不利于视频的增删，所以改成了对象来控制，粗略的设计结构如下
    ```json
        videoList: {
            "0": {
                "name": "aaa",
                "src": "",
                "poster": "",
                "next": "1",    // 最后一个视频指向"-1"
                "action": {
                    "type": "click",    // 两个视频间的交互模式，可能没有交互模式则没有action字段，根据需求有选择、点击、录音等交互模式
                    "area": {
                        "img": "",
                        "left": 0,
                        "top": 0,
                        "width": 0,
                        "height": 9
                    }
                }
            }
        }
    ```
3. 这个结构相对来说能满足现在的交互模式的需求

## 微信小程序视频开发中出现的一些问题
1. video组件的poster失效：文档中写到如果video的controls为false则poster失效，因为需求需要关闭原生controls，且如果没有poster，两个视频的衔接就会出现一闪的黑屏，所以后来通过一个cover-image来模拟poster在两个视频的过度阶段进行展示，主要是在videoPlay、videoLoadMetaData进行展示，videoTimeUpdate进行隐藏，不过这里没有用display进行隐藏，而是用fixed布局进行top控制。
2. 发现iOS的video视频播放结束后视频展示的是第一帧，而Android的是最后一帧。这个时候就导致我如果想要进行视频结束后切换回出现画面闪回第一帧再重新开始，所以我就在视频最后一秒把iOS的视频暂停，然后直接切到下一个视频，虽然这个能解决问题，但是需要保证最后一秒没有其他的视频动作，不然就会看起来不是很衔接，最好最后一秒都是一个静态的画面。
3. 原本是用定时器来设计视频最后10s倒计时处理的，但是有些时候计时器却不能更上视频进度，后来就改用videoTimeUpdate来计算，防止了计时器倒计时错误。
4. 小程序的动画api不能实现不断的动态帧，所以还是得依赖css的animation，其实发现css的animation比用js实现不断替换background-position性能更好。
5. 小程序的动画api如果进行页面跳转navigateTo，会发现页面返回上一页时动画无法还原，我只能通过redirectTo进行代替，然后在页面加返回按钮。
6. 小程序新版开始有隐藏顶部home按钮的api，这个如果你在做页面跳转的时候，同时快速点击home键会发现页面跳到首页又跳回你原先页面要跳转的页面。所以需要在页面跳转的时候触发隐藏home键。
7. 视频、音频、图片的预下载以及不要用display:none|block，不然可能出现无法展示
8. 资源的预下载很重要，做了个当前视频播放的时候预下载下一个视频到临时文件。
9. 图片的预加载和平常web开发不一样，小程序js没有Image()这个对象，所以使用new Image()会报错，只能通过在页面写个<image>标签，然后绑定error和load事件，进行一次次src的替换和load
10. 小程序的一些代码和api还不是很熟悉，这次写得还不够好，应该避免重复的变量定义在data里面，因为这样需要改变的时候需要一直setData，另外应该写个nextVideo的函数，专门处理下一个视频的逻辑。

## 关于这次小程序的思考
1. 现在小程序的开发文档不断更新，需要学习和了解新的api，而之前老的部分要牢牢掌握。
2. 小程序和小游戏的区别和开发学习，因为发现这次做的这种类游戏的，小程序并不能实现出app和小游戏的那种很好的体验。
3. 如果想进行下一版的更新迭代，需要视频制作方在每个视频的最后一秒是一个静态不变的页面，另外可以考虑是否一定要用mp4进行视频衔接，可否通过m3u8这样的ts不断变化的加载，这个只是一个个人观点，是否可行还需要进一步的研究学习以及询问相关人员。